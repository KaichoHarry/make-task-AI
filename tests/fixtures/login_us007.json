{
    "domain": "Invoicing Management System",
    "persona": "Accounting Representative",
    "action": "I want to accurately issue invoices from finalized deals or contract information",
    "reason": "To prevent errors in billing amounts and tax calculations, and to standardize collection operations",
    "acceptance_criteria": [
        "Invoice issuance is only executable by authenticated users.",
        "Only roles with issuance authority (e.g., Accounting/Admin) can execute issuance.",
        "Specifying either 'Deal ID' or 'Contract ID' as the issuance target is mandatory.",
        "Issuance fails if the specified Deal ID/Contract ID does not exist.",
        "Issuance fails if the specified Deal/Contract is logically deleted.",
        "Invoices must be linked to a Customer ID.",
        "Issuance fails if customer information (Name/Address/Contact/Billing Email, etc.) is missing (return missing items).",
        "Invoice number (invoice_no) must be unique within the system.",
        "Invoice numbering follows specific rules (e.g., INV-YYYYMM-Serial Number).",
        "Invoice numbers must not duplicate during simultaneous issuance (exclusive control at DB level).",
        "Issuance date/time (issued_at) is automatically recorded.",
        "Issuer User ID (issued_by) is automatically recorded.",
        "Payment due date (due_date) is mandatory.",
        "Payment due date must be on or after the issuance date (past dates not allowed).",
        "Invoice currency allows only predefined codes (e.g., JPY/VND/USD).",
        "At least one line item (items) is mandatory.",
        "Line items must contain 'Product Name/Quantity/Unit Price/Tax Category/Subtotal'.",
        "Product name is mandatory, maximum 100 characters.",
        "Quantity must be a numeric value greater than 0.",
        "Unit price must be a numeric value 0 or greater.",
        "Subtotal must match Quantity x Unit Price (recalculated on server; do not trust client values).",
        "Tax category allows only predefined values (e.g., Taxable/Non-taxable/Untaxable/Export Exempt).",
        "Consumption tax rate (tax_rate) is auto-determined by tax category or explicitly specified (configurable).",
        "Tax amount (tax_amount) is calculated on the server based on Subtotal x Tax Rate.",
        "Rounding rules (Truncate/Round Half Up/Round Up) apply based on company settings.",
        "Total amount (total) must match sum of item subtotals + sum of tax (calculated on server).",
        "Billing address holds multiple fields (Country/Prefecture/City/Address Line/Postal Code).",
        "Format validation is performed for Postal Code and Phone Number.",
        "Bank account information (Remittance destination) is auto-reflected from company settings.",
        "Invoice remarks field allows maximum 500 characters.",
        "Remarks field must be sanitized (Anti-XSS).",
        "DB access uses parameterized queries/ORM; no SQL generation via string concatenation (Anti-SQL Injection).",
        "Invoice issuance process is completed within a DB transaction.",
        "If an exception occurs during issuance, the invoice record is not created and is rolled back.",
        "Setting to prevent duplicate invoices from the same Deal/Contract is possible (Toggle ON/OFF).",
        "Duplicate detection uses keys such as (Customer ID + Target ID + Billing Period).",
        "Must have an invoice status (Draft/Issued/Sent/Paid/Cancelled).",
        "Status immediately after creation is 'Draft'.",
        "PDF generation is executed when transitioning to 'Issued'.",
        "PDF is generated based on a template showing invoice number, customer info, items, and total.",
        "Status transition fails and error logs are stored if PDF generation fails.",
        "Generated PDF stores a hash value (pdf_hash) to prevent tampering.",
        "PDF files are stored in encrypted storage.",
        "Permission checks are mandatory for PDF downloads.",
        "Direct link access to PDFs is prohibited (control via signed URLs, etc.).",
        "Transitioning to 'Sent' is only executable by roles with sending authority.",
        "During email sending, recipient defaults to customer billing email; manual changes are restricted by permission.",
        "Email body templates can be used.",
        "Email sending is executed via an asynchronous queue.",
        "Emails are retried upon failure; an alert occurs upon final failure.",
        "Sending logs are stored (invoice_id/recipient/result/timestamp).",
        "Payment date (paid_at) is mandatory when updating status to 'Paid'.",
        "Updating to 'Paid' is only possible by authorized roles.",
        "Invoice cancellation (Cancelled) is a logical cancellation; original data is retained.",
        "Reason for cancellation (max 300 chars) is mandatory when 'Cancelled'.",
        "Cancellation reason must be sanitized (Anti-XSS).",
        "Update history for invoices is maintained.",
        "Update history includes before/after values, updater, and timestamp.",
        "Audit logs are stored (user_id/op_type/target_invoice_id/IP/User-Agent/timestamp).",
        "Audit logs are stored in tamper-evident storage.",
        "Same validation applies to API issuance as UI.",
        "API is REST-compliant (POST /invoices, PATCH /invoices/{id}, etc.).",
        "API versioning is managed.",
        "Invalid requests return appropriate HTTP status (400/401/403/404/409/429).",
        "Error responses do not include internal exception info or SQL.",
        "Rate limiting is applied.",
        "Target response time for invoice issuance API is within 500ms (PDF generation can be asynchronous).",
        "Character code is unified in UTF-8.",
        "Time zone follows system settings; dates/times handled in ISO-8601."
    ]
}